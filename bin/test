#!/usr/bin/env bash

export RABBIT_PORT=61234
export BEANSTALK_PORT=61235

# Clean up old services that may be hanging around
docker rm --force grind-rabbit grind-beanstalk > /dev/null 2>&1

echo "Starting services"
docker run --name=grind-rabbit -d -p $RABBIT_PORT:5672 rabbitmq:3.7-alpine > /dev/null 2>&1
docker run --name=grind-beanstalk -d -p $BEANSTALK_PORT:11300 kusmierz/beanstalkd > /dev/null 2>&1

# Wait for services
docker run \
	--link=grind-beanstalk:beanstalk \
	--link=grind-rabbit:rabbit \
	dadarek/wait-for-dependencies \
		beanstalk:11300 \
		rabbit:5672

echo "Running tests"
NODE_ENV=test ava "$@"
EXIT_CODE=$?

echo "Cleaning up"
docker stop grind-rabbit grind-beanstalk > /dev/null 2>&1
docker rm grind-rabbit grind-beanstalk > /dev/null 2>&1

exit $EXIT_CODE
