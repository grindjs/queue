#!/usr/bin/env bash

export BEANSTALK_PORT=61235

# Clean up old services that may be hanging around
docker rm --force grind-beanstalk > /dev/null 2>&1

echo "Starting services"
docker run --name=grind-beanstalk -d -p $BEANSTALK_PORT:11300 kusmierz/beanstalkd > /dev/null 2>&1

# Wait for services
docker run \
	--link=grind-beanstalk:beanstalk \
	dadarek/wait-for-dependencies \
		beanstalk:11300

echo "Running tests"
NODE_ENV=test ava "$@"
EXIT_CODE=$?

echo "Cleaning up"
docker stop grind-beanstalk > /dev/null 2>&1
docker rm grind-beanstalk > /dev/null 2>&1

exit $EXIT_CODE
